name: Create Release                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                          
on:                                                                                                                                                                                                                                                      
  push:                                                                                                                                                                                                                                                  
    branches:                                                                                                                                                                                                                                            
      - master                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                         
jobs:                                                                                                                                                                                                                                                    
  build:                                                                                                                                                                                                                                                 
    runs-on: ubuntu-latest                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                         
    steps:                                                                                                                                                                                                                                               
    - name: Checkout repository                                                                                                                                                                                                                          
      uses: actions/checkout@v3                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                         
    - name: Install Node.js                                                                                                                                                                                                                              
      uses: actions/setup-node@v3                                                                                                                                                                                                                        
      with:                                                                                                                                                                                                                                              
        node-version: '20' # Ensure this matches your Node.js version                                                                                                                                                                                    
                                                                                                                                                                                                                                                         
    - name: Install dependencies                                                                                                                                                                                                                         
      run: yarn install                                                                                                                                                                                                                                  
  
    - name: Get Package Version
      id: package_version
      run: echo ::set-output name=PACKAGE_VERSION::$(node -p "require('./package.json').version")

    - name: Build for Linux                                                                                                                                                                                                                              
      run: yarn build:linux                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                         
    - name: Create Release                                                                                                                                                                                                                               
      id: create_release                                                                                                                                                                                                                                 
      uses: actions/create-release@v1                                                                                                                                                                                                                    
      env:                                                                                                                                                                                                                                               
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}                                                                                                                                                                                                        
      with:                                                                                                                                                                                                                                              
        tag_name: v${{ steps.package_version.outputs.PACKAGE_VERSION }}                                                                                                                                                                                                           
        release_name: Release v${{ steps.package_version.outputs.PACKAGE_VERSION }}                                                                                                                                                                                                
        draft: false                                                                                                                                                                                                                                     
        prerelease: false                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                         
    - name: Upload Release Asset (.AppImage)                                                                                                                                                                                                                         
      uses: actions/upload-release-asset@v1                                                                                                                                                                                                              
      env:                                                                                                                                                                                                                                               
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}                                                                                                                                                                                                        
      with:                                                                                                                                                                                                                                              
        upload_url: ${{ steps.create_release.outputs.upload_url }}                                                                                                                                                                                       
        asset_path: ./dist/davinci-resolve-converter-${{ steps.package_version.outputs.PACKAGE_VERSION }}.AppImage                                                                                                                                                                 
        asset_name: davinci-resolve-converter-${{ steps.package_version.outputs.PACKAGE_VERSION }}.AppImage                                                                                                                                                                        
        asset_content_type: application/x-appimage 

    - name: Upload Release Asset (.deb)                                                                                                                                                                                                                         
      uses: actions/upload-release-asset@v1                                                                                                                                                                                                              
      env:                                                                                                                                                                                                                                               
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}                                                                                                                                                                                                        
      with:                                                                                                                                                                                                                                              
        upload_url: ${{ steps.create_release.outputs.upload_url }}                                                                                                                                                                                       
        asset_path: ./dist/davinci-resolve-converter_${{ steps.package_version.outputs.PACKAGE_VERSION }}_amd64.deb                                                                                                                                                                      
        asset_name: davinci-resolve-converter_${{ steps.package_version.outputs.PACKAGE_VERSION }}_amd64.deb                                                                                                                                                                             
        asset_content_type: application/x-deb
